FROM debian:latest

# NGINX IS A WEB SERVER & AN INVERSE PROXY SERVER LIGHT OPEN SOURCE SOFTWARE
# IT IS USED TO SERVE STATIC FILES AND TO REVERSE PROXY TO PHP-FPM
# ALSO IT IS KNOWN FOR ITS HIGH PERFORMANCE AND LOW MEMORY USAGE
# AND CAPACITY TO HANDLE A LARGE NUMBER OF CONCURRENT CONNECTIONS & LOT OF WEB TRAFFIC

# BASIC INSTALLATION OF NGINX
RUN apt-get update 
RUN apt upgrade 
RUN apt install nginx -y
RUN apt install curl -y 
RUN apt install vim -y

# NOW WE HAVE TO SET UP THE SSL CERTIFICATE FOR OUR WEBSITE
RUN mkdir -p /etc/nginx/ssl
RUN apt install openssl -y
RUN openssl req -x509 -nodes \
    -out /etc/nginx/ssl/inception.crt \
    -keyout /etc/nginx/ssl/inception.key \
    -subj "/C=FR/ST=Paris/L=Paris/O=42/OU=42/CN=elmaleuv.42.fr/UID=elmaleuv"

# WE HAVE TO CREATE A DIRECTORY FOR NGINX PID FILE
RUN mkdir -p /var/run/nginx

# COPY THE NGINX CONFIGURATION FILE TO MODIFY IT
COPY conf/default /etc/nginx/sites-available/default

# CHANGE THE PERMISSIONS OF THE HTML DIRECTORY FOR NGINX TO ACCESS IT
RUN chmod 755 /var/www/html

# CHANGE THE OWNER OF THE HTML DIRECTORY TO WWW-DATA (NGINX USER BY DEFAULT IN DEBIAN)
# TO AVOID PERMISSION DENIED ERRORS WHEN NGINX TRIES TO ACCESS THE FILES
RUN chown -R www-data:www-data /var/www/html

# EXPOSE PORT 443 FOR HTTPS (SECURED CONNEXTION ON HTTP PROTOCOL)
EXPOSE 443

# START NGINX IN DEMON MODE OFF (TO KEEP THE CONTAINER RUNNING IN THE FIRST PLAN)
CMD ["nginx", "-g", "daemon off;"]
